@layout EmptyLayout
@page "/"
@using MoneyNoteLibrary5.ViewModels;
@using MoneyNoteLibrary5.Models;
@using System.Threading;
@inject IJSRuntime JS;
@*<div class="main">
        <div class="content px-4 text-center">

        </div>
    </div>*@

<div class="row justify-content-center">
    <form>
        <img class="mb-4" src="../assets/brand/bootstrap-logo.svg" alt="" width="72" height="57">
        <h1 class="h3 mb-3 fw-normal">Please sign in</h1>

        <div class="form-floating">
            <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com" @bind="ViewModel.Email" />
            <label for="floatingInput">Email address</label>
        </div>
        <div class="form-floating">
            <input type="password" class="form-control" id="floatingPassword" placeholder="Password" @bind="ViewModel.Password" />
            <label for="floatingPassword">Password</label>
        </div>

        <div class="checkbox mb-3">
            <label>
                @*<input type="checkbox" value="remember-me"> Remember me*@
                <input type="checkbox" @bind-value="IsContainLogin" name="isContainLogin" /> 로그인 유지
            </label>
        </div>
        <button class="w-100 btn btn-lg btn-primary" type="button" @onclick="Login">Sign in</button>
        <p class="mt-5 mb-3 text-muted">&copy; 2017–2021</p>
    </form>
</div>



@code
{
    [Inject]
    public NavigationManager NavigationManager { get; set; }

    public LoginViewModel ViewModel { get; set; } = new LoginViewModel();

    public bool IsContainLogin { get; set; }

    protected override Task OnParametersSetAsync()
    {
        return base.OnParametersSetAsync();
    }

    protected override void OnInitialized()
    {
#if DEBUG
        Thread.Sleep(5000);
#endif


        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await SharedClass.GetItemInLocalStorage<string>(JS, SharedClass.Keys.KeepLogin);
        bool.TryParse(result, out bool result22);
        if (result22)
        {
            var userInfo = await SharedClass.GetItemInLocalStorage<string>(JS, SharedClass.Keys.userKey);
            var user = JsonConvert.DeserializeObject<User>(userInfo);


            if (user.Id != Guid.Empty)
                NavigationManager?.NavigateTo("/Money/MoneyList");
        }
        else
        {
            // delete user key
            await SharedClass.SetItemInLocallStorage(JS, SharedClass.Keys.userKey, null);
        }

        //return base.OnAfterRenderAsync(firstRender);
    }

    private async Task Login()
    {
        if (!ViewModel.IsEnableLogin)
            return;

        var result = await ViewModel.LogIn();
        if (result.Item1)
        {
            SharedClass.SharedUser = result.Item2;
            //var saveResult = await JS.InvokeAsync<bool>("SetUserInfo", JsonConvert.SerializeObject(result.Item2));
            await SharedClass.SetItemInLocallStorage(JS, SharedClass.Keys.userKey, result.Item2);

            if (IsContainLogin)
            {
                await SharedClass.SetItemInLocallStorage(JS, SharedClass.Keys.KeepLogin, true);
            }


            NavigationManager?.NavigateTo("/Money/MoneyList");
        }
    }
}